<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<!--
/* Medama Cherenkov Maker
 * Copyright (C) 2010 anekos <medama-cherenkov-maker@snca.net>
 *
 * GIMP - The GNU Image Manipulation Program
 * Copyright (C) 1995 Spencer Kimball and Peter Mattis
 *
 * Supernova plug-in
 * Copyright (C) 1997 Eiichi Takamori <taka@ma1.seikyou.ne.jp>,
 *                    Spencer Kimball, Federico Mena Quintero
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
 */
-->

<html lang="ja">
  <head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">

    <meta property="og:title" content="Medama Cherenkov Maker" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="http://cherenkov.snca.net/" />
    <meta property="og:image" content="https://gyazo.snca.net/2018/11/27-190111-3aaeddbb90b571e2b6461e5edf8be1b9.gif" />
    <meta property="og:site_name" content="Medama Cherenkov Maker" />
    <meta property="og:description" content="Make your photo cherenkov" />

    <meta content="summary_large_image" name="twitter:card" />

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-127415492-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-127415492-1');
    </script>

    <style>
      .row {
        display: flex;
        justify-content: space-between;
      }
    </style>

    <title>Medama Cherenkov Maker</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link href="lib/wiv/css/wiv-style.css" rel="stylesheet" type="text/css" media="all">
  </head>
  <body>

    <h1>写真激盛りアプリで目を光らせよう!!</h1>

    <p><img src="https://gyazo.snca.net/2018/11/27-190111-3aaeddbb90b571e2b6461e5edf8be1b9.gif"></p>

    <!-- {{{ Settings -->
    <div class="wiv" data-wiv-speed="4.15" data-wiv-height="5" data-wiv-tightness="6" data-wiv-thickness="2" data-wiv-color="yellow">
      <div class="wiv-content">

        <div id="dropbox"><img id="pic" style="display: none" crossorigin/></div>

        <div class="row">
          <span>色 / Color (<span id="colorvalue"></span>):</span> <select id="color">
            <option style="">Random</option>
            <option style="background-color: AliceBlue">AliceBlue</option>
            <option style="background-color: AntiqueWhite">AntiqueWhite</option>
            <option style="background-color: Aqua">Aqua</option>
            <option style="background-color: Aquamarine">Aquamarine</option>
            <option style="background-color: Azure">Azure</option>
            <option style="background-color: Beige">Beige</option>
            <option style="background-color: Bisque">Bisque</option>
            <option style="background-color: Black">Black</option>
            <option style="background-color: BlanchedAlmond">BlanchedAlmond</option>
            <option style="background-color: Blue" selected=1>Blue</option>
            <option style="background-color: BlueViolet">BlueViolet</option>
            <option style="background-color: Brown">Brown</option>
            <option style="background-color: Burlywood">Burlywood</option>
            <option style="background-color: CadetBlue">CadetBlue</option>
            <option style="background-color: Chartreuse">Chartreuse</option>
            <option style="background-color: Chocolate">Chocolate</option>
            <option style="background-color: Coral">Coral</option>
            <option style="background-color: CornflowerBlue">CornflowerBlue</option>
            <option style="background-color: Cornsilk">Cornsilk</option>
            <option style="background-color: Crimson">Crimson</option>
            <option style="background-color: Cyan">Cyan</option>
            <option style="background-color: DarkBlue">DarkBlue</option>
            <option style="background-color: DarkCyan">DarkCyan</option>
            <option style="background-color: DarkGoldenrod">DarkGoldenrod</option>
            <option style="background-color: DarkGray">DarkGray</option>
            <option style="background-color: DarkGreen">DarkGreen</option>
            <option style="background-color: DarkKhaki">DarkKhaki</option>
            <option style="background-color: DarkMagenta">DarkMagenta</option>
            <option style="background-color: DarkOliveGreen">DarkOliveGreen</option>
            <option style="background-color: DarkOrange">DarkOrange</option>
            <option style="background-color: DarkOrchid">DarkOrchid</option>
            <option style="background-color: DarkRed">DarkRed</option>
            <option style="background-color: DarkSalmon">DarkSalmon</option>
            <option style="background-color: DarkSeaGreen">DarkSeaGreen</option>
            <option style="background-color: DarkSlateBlue">DarkSlateBlue</option>
            <option style="background-color: DarkSlateGray">DarkSlateGray</option>
            <option style="background-color: DarkTurquoise">DarkTurquoise</option>
            <option style="background-color: DarkViolet">DarkViolet</option>
            <option style="background-color: DeepPink">DeepPink</option>
            <option style="background-color: DeepSkyBlue">DeepSkyBlue</option>
            <option style="background-color: DimGray">DimGray</option>
            <option style="background-color: DodgerBlue">DodgerBlue</option>
            <option style="background-color: Firebrick">Firebrick</option>
            <option style="background-color: FloralWhite">FloralWhite</option>
            <option style="background-color: ForestGreen">ForestGreen</option>
            <option style="background-color: Fuchsia">Fuchsia</option>
            <option style="background-color: Gainsboro">Gainsboro</option>
            <option style="background-color: GhostWhite">GhostWhite</option>
            <option style="background-color: Gold">Gold</option>
            <option style="background-color: Goldenrod">Goldenrod</option>
            <option style="background-color: Gray">Gray</option>
            <option style="background-color: Green">Green</option>
            <option style="background-color: GreenYellow">GreenYellow</option>
            <option style="background-color: Honeydew">Honeydew</option>
            <option style="background-color: HotPink">HotPink</option>
            <option style="background-color: IndianRed">IndianRed</option>
            <option style="background-color: Indigo">Indigo</option>
            <option style="background-color: Ivory">Ivory</option>
            <option style="background-color: Khaki">Khaki</option>
            <option style="background-color: Lavender">Lavender</option>
            <option style="background-color: LavenderBlush">LavenderBlush</option>
            <option style="background-color: LawnGreen">LawnGreen</option>
            <option style="background-color: LemonChiffon">LemonChiffon</option>
            <option style="background-color: LightBlue">LightBlue</option>
            <option style="background-color: LightCoral">LightCoral</option>
            <option style="background-color: LightCyan">LightCyan</option>
            <option style="background-color: LightGoldenrodYellow">LightGoldenrodYellow</option>
            <option style="background-color: LightGreen">LightGreen</option>
            <option style="background-color: LightGrey">LightGrey</option>
            <option style="background-color: LightPink">LightPink</option>
            <option style="background-color: LightSalmon">LightSalmon</option>
            <option style="background-color: LightSeaGreen">LightSeaGreen</option>
            <option style="background-color: LightSkyBlue">LightSkyBlue</option>
            <option style="background-color: LightSlateGray">LightSlateGray</option>
            <option style="background-color: LightSteelBlue">LightSteelBlue</option>
            <option style="background-color: LightYellow">LightYellow</option>
            <option style="background-color: Lime">Lime</option>
            <option style="background-color: LimeGreen">LimeGreen</option>
            <option style="background-color: Linen">Linen</option>
            <option style="background-color: Magenta">Magenta</option>
            <option style="background-color: Maroon">Maroon</option>
            <option style="background-color: MediumAquamarine">MediumAquamarine</option>
            <option style="background-color: MediumBlue">MediumBlue</option>
            <option style="background-color: MediumOrchid">MediumOrchid</option>
            <option style="background-color: MediumPurple">MediumPurple</option>
            <option style="background-color: MediumSeaGreen">MediumSeaGreen</option>
            <option style="background-color: MediumSlateBlue">MediumSlateBlue</option>
            <option style="background-color: MediumSpringGreen">MediumSpringGreen</option>
            <option style="background-color: MediumTurquoise">MediumTurquoise</option>
            <option style="background-color: MediumVioletRed">MediumVioletRed</option>
            <option style="background-color: MidnightBlue">MidnightBlue</option>
            <option style="background-color: MintCream">MintCream</option>
            <option style="background-color: MistyRose">MistyRose</option>
            <option style="background-color: Moccasin">Moccasin</option>
            <option style="background-color: NavajoWhite">NavajoWhite</option>
            <option style="background-color: Navy">Navy</option>
            <option style="background-color: OldLace">OldLace</option>
            <option style="background-color: Olive">Olive</option>
            <option style="background-color: OliveDrab">OliveDrab</option>
            <option style="background-color: Orange">Orange</option>
            <option style="background-color: OrangeRed">OrangeRed</option>
            <option style="background-color: Orchid">Orchid</option>
            <option style="background-color: PaleGoldenrod">PaleGoldenrod</option>
            <option style="background-color: PaleGreen">PaleGreen</option>
            <option style="background-color: PaleTurquoise">PaleTurquoise</option>
            <option style="background-color: PaleVioletRed">PaleVioletRed</option>
            <option style="background-color: PapayaWhip">PapayaWhip</option>
            <option style="background-color: PeachPuff">PeachPuff</option>
            <option style="background-color: Peru">Peru</option>
            <option style="background-color: Pink">Pink</option>
            <option style="background-color: Plum">Plum</option>
            <option style="background-color: PowderBlue">PowderBlue</option>
            <option style="background-color: Purple">Purple</option>
            <option style="background-color: Red">Red</option>
            <option style="background-color: RosyBrown">RosyBrown</option>
            <option style="background-color: RoyalBlue">RoyalBlue</option>
            <option style="background-color: SaddleBrown">SaddleBrown</option>
            <option style="background-color: Salmon">Salmon</option>
            <option style="background-color: SandyBrown">SandyBrown</option>
            <option style="background-color: SeaGreen">SeaGreen</option>
            <option style="background-color: Seashell">Seashell</option>
            <option style="background-color: Sienna">Sienna</option>
            <option style="background-color: Silver">Silver</option>
            <option style="background-color: SkyBlue">SkyBlue</option>
            <option style="background-color: SlateBlue">SlateBlue</option>
            <option style="background-color: SlateGray">SlateGray</option>
            <option style="background-color: Snow">Snow</option>
            <option style="background-color: SpringGreen">SpringGreen</option>
            <option style="background-color: SteelBlue">SteelBlue</option>
            <option style="background-color: Tan">Tan</option>
            <option style="background-color: Teal">Teal</option>
            <option style="background-color: Thistle">Thistle</option>
            <option style="background-color: Tomato">Tomato</option>
            <option style="background-color: Turquoise">Turquoise</option>
            <option style="background-color: Violet">Violet</option>
            <option style="background-color: Wheat">Wheat</option>
            <option style="background-color: White">White</option>
            <option style="background-color: WhiteSmoke">WhiteSmoke</option>
            <option style="background-color: Yellow">Yellow</option>
            <option style="background-color: YellowGreen">YellowGreen</option>
          </select>
        </div>

        <div class="row">
          <span>半径 / Radius (0 - 100):</span>
          <input id="radius" type="number" value="20">
        </div>

        <div class="row">
          <span>放射 / Spokes (0 - 100):</span>
          <input id="nspoke" type="number" value="100">
        </div>

        <div class="row">
          <span>乱数色相 / Random Hue (0 - 360):</span>
          <input id="randomhue" type="number" value="0">
        </div>

        <div class="row">
          <span>FPS (15 - 60):</span>
          <input id="fps" type="number" value="15">
        </div>

        <div class="row">
          <span>アニメフレーム数 / Animation frames (2 - 10):</span>
          <input id="framecount" type="number" value="2" title="Thank you, tyru!">
        </div>

        <div class="row">
          <span>背景 / Background:</span>
          <select id="background">
            <option style="background-color: AliceBlue">AliceBlue</option>
            <option style="background-color: AntiqueWhite">AntiqueWhite</option>
            <option style="background-color: Aqua">Aqua</option>
            <option style="background-color: Aquamarine">Aquamarine</option>
            <option style="background-color: Azure">Azure</option>
            <option style="background-color: Beige">Beige</option>
            <option style="background-color: Bisque">Bisque</option>
            <option style="background-color: Black">Black</option>
            <option style="background-color: BlanchedAlmond">BlanchedAlmond</option>
            <option style="background-color: Blue" selected=1>Blue</option>
            <option style="background-color: BlueViolet">BlueViolet</option>
            <option style="background-color: Brown">Brown</option>
            <option style="background-color: Burlywood">Burlywood</option>
            <option style="background-color: CadetBlue">CadetBlue</option>
            <option style="background-color: Chartreuse">Chartreuse</option>
            <option style="background-color: Chocolate">Chocolate</option>
            <option style="background-color: Coral">Coral</option>
            <option style="background-color: CornflowerBlue">CornflowerBlue</option>
            <option style="background-color: Cornsilk">Cornsilk</option>
            <option style="background-color: Crimson">Crimson</option>
            <option style="background-color: Cyan">Cyan</option>
            <option style="background-color: DarkBlue">DarkBlue</option>
            <option style="background-color: DarkCyan">DarkCyan</option>
            <option style="background-color: DarkGoldenrod">DarkGoldenrod</option>
            <option style="background-color: DarkGray">DarkGray</option>
            <option style="background-color: DarkGreen">DarkGreen</option>
            <option style="background-color: DarkKhaki">DarkKhaki</option>
            <option style="background-color: DarkMagenta">DarkMagenta</option>
            <option style="background-color: DarkOliveGreen">DarkOliveGreen</option>
            <option style="background-color: DarkOrange">DarkOrange</option>
            <option style="background-color: DarkOrchid">DarkOrchid</option>
            <option style="background-color: DarkRed">DarkRed</option>
            <option style="background-color: DarkSalmon">DarkSalmon</option>
            <option style="background-color: DarkSeaGreen">DarkSeaGreen</option>
            <option style="background-color: DarkSlateBlue">DarkSlateBlue</option>
            <option style="background-color: DarkSlateGray">DarkSlateGray</option>
            <option style="background-color: DarkTurquoise">DarkTurquoise</option>
            <option style="background-color: DarkViolet">DarkViolet</option>
            <option style="background-color: DeepPink">DeepPink</option>
            <option style="background-color: DeepSkyBlue">DeepSkyBlue</option>
            <option style="background-color: DimGray">DimGray</option>
            <option style="background-color: DodgerBlue">DodgerBlue</option>
            <option style="background-color: Firebrick">Firebrick</option>
            <option style="background-color: FloralWhite">FloralWhite</option>
            <option style="background-color: ForestGreen">ForestGreen</option>
            <option style="background-color: Fuchsia">Fuchsia</option>
            <option style="background-color: Gainsboro">Gainsboro</option>
            <option style="background-color: GhostWhite">GhostWhite</option>
            <option style="background-color: Gold">Gold</option>
            <option style="background-color: Goldenrod">Goldenrod</option>
            <option style="background-color: Gray">Gray</option>
            <option style="background-color: Green">Green</option>
            <option style="background-color: GreenYellow">GreenYellow</option>
            <option style="background-color: Honeydew">Honeydew</option>
            <option style="background-color: HotPink">HotPink</option>
            <option style="background-color: IndianRed">IndianRed</option>
            <option style="background-color: Indigo">Indigo</option>
            <option style="background-color: Ivory">Ivory</option>
            <option style="background-color: Khaki">Khaki</option>
            <option style="background-color: Lavender">Lavender</option>
            <option style="background-color: LavenderBlush">LavenderBlush</option>
            <option style="background-color: LawnGreen">LawnGreen</option>
            <option style="background-color: LemonChiffon">LemonChiffon</option>
            <option style="background-color: LightBlue">LightBlue</option>
            <option style="background-color: LightCoral">LightCoral</option>
            <option style="background-color: LightCyan">LightCyan</option>
            <option style="background-color: LightGoldenrodYellow">LightGoldenrodYellow</option>
            <option style="background-color: LightGreen">LightGreen</option>
            <option style="background-color: LightGrey">LightGrey</option>
            <option style="background-color: LightPink">LightPink</option>
            <option style="background-color: LightSalmon">LightSalmon</option>
            <option style="background-color: LightSeaGreen">LightSeaGreen</option>
            <option style="background-color: LightSkyBlue">LightSkyBlue</option>
            <option style="background-color: LightSlateGray">LightSlateGray</option>
            <option style="background-color: LightSteelBlue">LightSteelBlue</option>
            <option style="background-color: LightYellow">LightYellow</option>
            <option style="background-color: Lime">Lime</option>
            <option style="background-color: LimeGreen">LimeGreen</option>
            <option style="background-color: Linen">Linen</option>
            <option style="background-color: Magenta">Magenta</option>
            <option style="background-color: Maroon">Maroon</option>
            <option style="background-color: MediumAquamarine">MediumAquamarine</option>
            <option style="background-color: MediumBlue">MediumBlue</option>
            <option style="background-color: MediumOrchid">MediumOrchid</option>
            <option style="background-color: MediumPurple">MediumPurple</option>
            <option style="background-color: MediumSeaGreen">MediumSeaGreen</option>
            <option style="background-color: MediumSlateBlue">MediumSlateBlue</option>
            <option style="background-color: MediumSpringGreen">MediumSpringGreen</option>
            <option style="background-color: MediumTurquoise">MediumTurquoise</option>
            <option style="background-color: MediumVioletRed">MediumVioletRed</option>
            <option style="background-color: MidnightBlue">MidnightBlue</option>
            <option style="background-color: MintCream">MintCream</option>
            <option style="background-color: MistyRose">MistyRose</option>
            <option style="background-color: Moccasin">Moccasin</option>
            <option style="background-color: NavajoWhite">NavajoWhite</option>
            <option style="background-color: Navy">Navy</option>
            <option style="background-color: OldLace">OldLace</option>
            <option style="background-color: Olive">Olive</option>
            <option style="background-color: OliveDrab">OliveDrab</option>
            <option style="background-color: Orange">Orange</option>
            <option style="background-color: OrangeRed">OrangeRed</option>
            <option style="background-color: Orchid">Orchid</option>
            <option style="background-color: PaleGoldenrod">PaleGoldenrod</option>
            <option style="background-color: PaleGreen">PaleGreen</option>
            <option style="background-color: PaleTurquoise">PaleTurquoise</option>
            <option style="background-color: PaleVioletRed">PaleVioletRed</option>
            <option style="background-color: PapayaWhip">PapayaWhip</option>
            <option style="background-color: PeachPuff">PeachPuff</option>
            <option style="background-color: Peru">Peru</option>
            <option style="background-color: Pink">Pink</option>
            <option style="background-color: Plum">Plum</option>
            <option style="background-color: PowderBlue">PowderBlue</option>
            <option style="background-color: Purple">Purple</option>
            <option style="background-color: Red">Red</option>
            <option style="background-color: RosyBrown">RosyBrown</option>
            <option style="background-color: RoyalBlue">RoyalBlue</option>
            <option style="background-color: SaddleBrown">SaddleBrown</option>
            <option style="background-color: Salmon">Salmon</option>
            <option style="background-color: SandyBrown">SandyBrown</option>
            <option style="background-color: SeaGreen">SeaGreen</option>
            <option style="background-color: Seashell">Seashell</option>
            <option style="background-color: Sienna">Sienna</option>
            <option style="background-color: Silver">Silver</option>
            <option style="background-color: SkyBlue">SkyBlue</option>
            <option style="background-color: SlateBlue">SlateBlue</option>
            <option style="background-color: SlateGray">SlateGray</option>
            <option style="background-color: Snow">Snow</option>
            <option style="background-color: SpringGreen">SpringGreen</option>
            <option style="background-color: SteelBlue">SteelBlue</option>
            <option style="background-color: Tan">Tan</option>
            <option style="background-color: Teal">Teal</option>
            <option style="background-color: Thistle">Thistle</option>
            <option style="background-color: Tomato">Tomato</option>
            <option style="background-color: Turquoise">Turquoise</option>
            <option style="background-color: Violet">Violet</option>
            <option style="background-color: Wheat">Wheat</option>
            <option style="background-color: White" selected>White</option>
            <option style="background-color: WhiteSmoke">WhiteSmoke</option>
            <option style="background-color: Yellow">Yellow</option>
            <option style="background-color: YellowGreen">YellowGreen</option>
          </select>
        </div>

        <button id="reset">りせっと / Reset</button>
        <button id="redraw">もっかい描画 / Redraw</button>
      </div>
    </div>
    <!-- }}} -->

    <!-- {{{ Canvas -->
    <br />

    <!--
    <div class="wiv" data-wiv-speed=".15" data-wiv-height="2" data-wiv-tightness="6" data-wiv-thickness="2" data-wiv-color="blue">
      <div class="wiv-content">
    -->

        <p id="desc">ここ↓に画像ファイルをドラッグ＆ドロップしてね。 / Drop a image file↓</p>
        <canvas id="canvas" width="150" height="150" style="border: 2px solid blue"></canvas>
        <br/>
        <img id="animated-preview" style='display: none;'>

        <input type="file" id="file-selector" onchange="loadFile(this.files[0])">
        <br/>
        画像縮小 / Image scaling: <select id="scaling">
          <option value="1.0" selected>100%</option>
          <option value="0.9">90%</option>
          <option value="0.8">80%</option>
          <option value="0.7">70%</option>
          <option value="0.6">60%</option>
          <option value="0.5">50%</option>
          <option value="0.4">40%</option>
          <option value="0.3">30%</option>
          <option value="0.2">20%</option>
          <option value="0.1">10%</option>
        </select>

        <br><br>
        <span>リアルのカード作れるよ→<a href="https://gifpop.io">gifpop!</a></span>

    <!--
      </div>
    </div>
    -->

    <br />

    <!-- }}} -->

    <!-- {{{ Footer -->

    <div class="wiv" data-wiv-speed="2.15" data-wiv-height="18" data-wiv-tightness="6" data-wiv-thickness="2" data-wiv-color="red">
      <div class="wiv-content">
        <div>
          &copy;anekos
          <span><a href="http://twitter.com/anekos/">Twitter</a></span>
          <span><a href="https://github.com/anekos/medama-cherenkov-maker">Github</a></span>
        </div>
      </div>
    </div>

    <div style="text-align: right;"><a href="./wasm.html">wasm</a></div>

    <canvas id="colorview" style="width: 30px; height: 30px; display: none">&nbsp;&nbsp;</canvas>

    <!-- }}} -->

    <!-- {{{ Script -->

    <script type="text/javascript" src='lib/jsgif/LZWEncoder.js'></script>
    <script type="text/javascript" src='lib/jsgif/NeuQuant.js'></script>
    <script type="text/javascript" src='lib/jsgif/GIFEncoder.js'></script>
    <script type="text/javascript" src='lib/jsgif/b64.js'></script>
    <script type="text/javascript">
      /**************************************************************************/

      function gauss () {
        var sum = 0.0;

        for (var i = 0; i < 6; i++)
          sum += Math.random();

        return sum / 6.0;
      }

      function rangeRand (from, to) {
        var d = to - from;
        return Math.random(d) + from;
      }

      function rgb2hsv (r, g, b) {
        var v = Math.max(Math.max(r, g), b);
        var min = Math.min(Math.min(r, g), b);

        if (v == 0)
          return {h: 0, s: 0, v: 0};

        var d = v - min;
        var s = d / v;
        var rr = (v - r) / d;
        var gg = (v - g) / d;
        var bb = (v - b) / d;

        var h = v == r ? bb - gg :
                v == g ? 2 + rr - bb :
                         4 + gg - rr;

        if (h < 0)
          h += 1;

        return {h: h / 6, s: s, v: v};
      }

      var hsv2rgb = (function () {
        var hrtbl = [
          [0, 3, 1],
          [2, 0, 1],
          [1, 0, 3],
          [1, 2, 0],
          [3, 1, 0],
          [0, 1, 2]
        ];

        return function (h, s, v) {
          if (s == 0)
            return [v, v, v];

          h *= 6;
          var i = Math.floor(h);

          var f = h - i;
          var rs = [v, v * (1 - s), v * (1 - s * f), v * (1 - s * (1 - f))];
          var idx = hrtbl[i];

          return [rs[idx[0]], rs[idx[1]], rs[idx[2]]];
        };
      })();

      function clamp (v, from, to) {
        return v < from ? from :
               v > to   ? to :
               v;
      }

      /**************************************************************************/

      function nova (context, opt) {
        var width = opt.width, height = opt.height;
        var xc = opt.xcenter, yc = opt.ycenter;
        var x1 = 0, y1 = 0, x2 = width, y2 = height;

        var imgData = context.getImageData(0, 0, width, height);
        var pixels = imgData.data;

        var spoke = [];
        var spokecolor = [];
        var hsv = rgb2hsv.apply(null, opt.color);

        for (var i = 0; i < opt.nspoke; i++) {
          spoke.push(gauss());
          hsv.h += opt.randomhue /
                    360.0 * rangeRand(-0.5, 0.5);

          if (hsv.h < 0)
            hsv.h += 1.0;
          else if (hsv.h >= 1.0)
            hsv.h -= 1.0;

          spokecolor.push(hsv2rgb(hsv.h, hsv.s, hsv.v));
        }

        for (var row = 0, y = 0; row < y2; row++, y++) {
          for (var col = 0, x = 0; col < x2; col++, x++) {
            var u = (x - xc) / opt.radius;
            var v = (y - yc) / opt.radius;
            var l = Math.sqrt(u * u + v * v);

            var t = (Math.atan2(u, v) / (2 * Math.PI) + 0.51) * opt.nspoke;
            var i = Math.floor(t);
            t -= i;
            i %= opt.nspoke;

            var w1 = spoke[i] * (1 - t) + spoke[(i + 1) % opt.nspoke] * t;
            w1 = w1 * w1;

            var w = 1 / (l + 0.001) * 0.9;
            var nova_alpha = clamp(w, 0.0, 1.0);
            var ratio = nova_alpha;
            var compl_ratio = 1.0 - ratio;
            var ptr = (y * width + x) * 4;

            for (var ci = 0; ci < 3; ci++ ) {
              var srccol = pixels[ptr + ci] / 255;
              var spokecol = spokecolor[i][ci] * (1.0 - t) + spokecolor[(i + 1) % opt.nspoke][ci] * t;

              var outcol = w > 1.0 ? clamp(spokecol * w, 0.0, 1.0) :
                                     srccol * compl_ratio + spokecol * ratio;

              var c = clamp(w1 * w, 0.0, 1.0);
              outcol += c;
              outcol *= 255;
              pixels[ptr + ci] = clamp(parseInt(outcol, 10), 0, 255);
            }
          }
        }

        context.putImageData(imgData, 0, 0);
      }

      function setCanvasWidthHeight () {
        canvas.width = img.width * scale;
        canvas.height = img.height * scale;
      }

      function drawBaseImage (context) {
        context.fillStyle = background.value;
        context.fillRect (0, 0, img.width * scale, img.height * scale);
        context.drawImage(img, 0, 0, img.width * scale, img.height * scale);
      }

      function clampedValue (id, from, to) {
        return clamp(parseInt(document.getElementById(id).value, 10), from, to);
      }

      function generateAniGIFDataURL (posList) {
        function createContext() {
          var c = document.createElement('canvas');
          c.width = canvas.width;
          c.height = canvas.height;
          return c.getContext('2d');
        }

        var context = createContext();
        var encoder = new GIFEncoder();
        encoder.setRepeat(0); // loop
        encoder.setDelay(1000 / clampedValue('fps', 15, 60));
        encoder.start();
        var frameCount = clampedValue('framecount', 2, 10);
        if (posList.length > 0) {
          for (var i = 0; i < frameCount; i++) {
            drawBaseImage(context);
            superNova(context, posList);
            encoder.addFrame(context);
          }
        }
        encoder.finish();
        var binaryGIF = encoder.stream().getData();
        return 'data:image/gif;base64,'+encode64(binaryGIF);
      }

      function getRandomColor() {
        return [Math.random(), Math.random(), Math.random(), 1.0];
      }

      function superNova (context, posList) {
        posList.forEach(function (pos) {
          nova(context, {
            width: img.width,
            height: img.height,
            xcenter: pos.x,
            ycenter: pos.y,
            color: rgbdata || getRandomColor(),
            radius: clampedValue('radius', 0, 100),
            nspoke: clampedValue('nspoke', 1, 100),
            randomhue: clampedValue('randomhue', 0, 360),
          });
        });
      }

      function animateSuperNova (posList) {
        var dataURL = generateAniGIFDataURL(posList);
        var preview = document.getElementById('animated-preview');
        preview.style.display = 'inline';
        preview.src = dataURL;
      }

      function loadFile (file) {
          var reader = new FileReader();
          reader.onloadend = function () {
            img.src = reader.result;
            reset.click();
          };
          reader.readAsDataURL(file);
      }


      var rgbdata;
      var clickedPosList = [];
      var color = document.getElementById("color");
      var background = document.getElementById("background");
      var colorvalue = document.getElementById("colorvalue");
      var colorview = document.getElementById("colorview");
      var reset = document.getElementById("reset");
      var redraw = document.getElementById("redraw");
      var desc = document.getElementById("desc");
      var dropbox = document.getElementById("canvas");
      var canvas = document.getElementById('canvas');
      var img = document.getElementById('pic');
      var scaling = document.getElementById('scaling');
      var context = canvas.getContext('2d');
      var scale = 1.0;


      img.addEventListener(
        'load',
        function () {
          desc.textContent = "光らせたい場所をクリックしてね！";
          setCanvasWidthHeight();
          drawBaseImage(context);
        },
        false
      );

      scaling.addEventListener(
        'change',
        function () {
          var oldScale = scale;
          scale = parseFloat(scaling.value);
          for (var i in clickedPosList) {
            clickedPosList[i].x = clickedPosList[i].x / oldScale * scale;
            clickedPosList[i].y = clickedPosList[i].y / oldScale * scale;
          }
          redraw.click();
        },
        false
      );

      reset.addEventListener(
        'click',
        function () {
          if (!img.src) {
            return;
          }
          var preview = document.getElementById('animated-preview');
          preview.style.display = 'none';

          clickedPosList = [];

          setCanvasWidthHeight();
          drawBaseImage(context);
        },
        true
      );

      redraw.addEventListener(
        'click',
        function () {
          if (!img.src) {
            return;
          }
          setCanvasWidthHeight();
          drawBaseImage(context);
          // 静止画 canvas を更新
          superNova(context, clickedPosList);
          // アニメ GIF の img 要素を更新
          if (clickedPosList.length > 0) {
            animateSuperNova(clickedPosList);
          }
        },
        true
      );

      dropbox.addEventListener(
        'dragenter',
        function (e) {
          e.stopPropagation();
          e.preventDefault();
        },
        false
      );

      dropbox.addEventListener(
        'dragover',
        function (e) {
          e.stopPropagation();
          e.preventDefault();
        },
        false
      );

      dropbox.addEventListener(
        'drop',
        function (e) {
          e.stopPropagation();
          e.preventDefault();
          loadFile(e.dataTransfer.files[0]);
        },
        false
      );

      canvas.addEventListener(
        'click',
        function (e) {
          if (!img.src) {
            return;
          }
          desc.textContent = "光らせた画像は、右クリックメニューから保存できるよ！";
          clickedPosList.push({
            x: e.pageX - e.target.offsetLeft - 2,
            y: e.pageY - e.target.offsetTop - 2,
          });
          setCanvasWidthHeight();
          drawBaseImage(context);
          // 静止画 canvas を更新
          superNova(context, clickedPosList);
          // アニメ GIF の img 要素を更新
          animateSuperNova(clickedPosList);
        },
        true
      );

      (function () {
        var params = {};
        location.search.slice(1).split('&').forEach(function (it) {
          var parts = it.split('=');
          params[parts[0]] = parts[1];
        });

        if (params.image)
          img.src = decodeURIComponent(params.image);
      })();

      (function () {
        function colorOnChange () {
          if (color.value == 'Random') {
            rgbdata = null;
            colorvalue.textContent = 'Random';
          } else {
            var context = colorview.getContext('2d');
            context.fillStyle = color.value;
            context.fillRect(0, 0, 100, 100);
            var cs = context.getImageData(0, 0, 1, 1).data;
            rgbdata = [cs[0] / 255, cs[1] / 255, cs[2] / 255];
          }
          colorvalue.textContent = cs.slice(0, 3);
        }

        color.addEventListener(
          'change',
          colorOnChange,
          true
        );

        colorOnChange();
      })();

    </script>

    <!-- }}} -->

    <script src="lib/wiv/wiv.js"></script>
  </body>
</html>

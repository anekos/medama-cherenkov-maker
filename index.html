<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<!--
/* Medama Cherenkov Maker
 * Copyright (C) 2010 anekos <anekos616@gmail.com(
 *
 * GIMP - The GNU Image Manipulation Program
 * Copyright (C) 1995 Spencer Kimball and Peter Mattis
 *
 * Supernova plug-in
 * Copyright (C) 1997 Eiichi Takamori <taka@ma1.seikyou.ne.jp>,
 *                    Spencer Kimball, Federico Mena Quintero
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
 */
-->

<html lang="ja">
  <head>
    <title>Medama Cherenkov Maker</title>
    <link rel="stylesheet" href="./style.css" type="text/css">
    <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>
  <body>
    <p><em> Chrome,Firefox 以外ではうごかないかもー </em></p>

    <div id="dropbox"><img id="pic" style="display: none" /></div>

    色(<span id="colorvalue"></span>): <select id="color">
      <option style="background-color: AliceBlue">AliceBlue</option>
      <option style="background-color: AntiqueWhite">AntiqueWhite</option>
      <option style="background-color: Aqua">Aqua</option>
      <option style="background-color: Aquamarine">Aquamarine</option>
      <option style="background-color: Azure">Azure</option>
      <option style="background-color: Beige">Beige</option>
      <option style="background-color: Bisque">Bisque</option>
      <option style="background-color: Black">Black</option>
      <option style="background-color: BlanchedAlmond">BlanchedAlmond</option>
      <option style="background-color: Blue" selected=1>Blue</option>
      <option style="background-color: BlueViolet">BlueViolet</option>
      <option style="background-color: Brown">Brown</option>
      <option style="background-color: Burlywood">Burlywood</option>
      <option style="background-color: CadetBlue">CadetBlue</option>
      <option style="background-color: Chartreuse">Chartreuse</option>
      <option style="background-color: Chocolate">Chocolate</option>
      <option style="background-color: Coral">Coral</option>
      <option style="background-color: CornflowerBlue">CornflowerBlue</option>
      <option style="background-color: Cornsilk">Cornsilk</option>
      <option style="background-color: Crimson">Crimson</option>
      <option style="background-color: Cyan">Cyan</option>
      <option style="background-color: DarkBlue">DarkBlue</option>
      <option style="background-color: DarkCyan">DarkCyan</option>
      <option style="background-color: DarkGoldenrod">DarkGoldenrod</option>
      <option style="background-color: DarkGray">DarkGray</option>
      <option style="background-color: DarkGreen">DarkGreen</option>
      <option style="background-color: DarkKhaki">DarkKhaki</option>
      <option style="background-color: DarkMagenta">DarkMagenta</option>
      <option style="background-color: DarkOliveGreen">DarkOliveGreen</option>
      <option style="background-color: DarkOrange">DarkOrange</option>
      <option style="background-color: DarkOrchid">DarkOrchid</option>
      <option style="background-color: DarkRed">DarkRed</option>
      <option style="background-color: DarkSalmon">DarkSalmon</option>
      <option style="background-color: DarkSeaGreen">DarkSeaGreen</option>
      <option style="background-color: DarkSlateBlue">DarkSlateBlue</option>
      <option style="background-color: DarkSlateGray">DarkSlateGray</option>
      <option style="background-color: DarkTurquoise">DarkTurquoise</option>
      <option style="background-color: DarkViolet">DarkViolet</option>
      <option style="background-color: DeepPink">DeepPink</option>
      <option style="background-color: DeepSkyBlue">DeepSkyBlue</option>
      <option style="background-color: DimGray">DimGray</option>
      <option style="background-color: DodgerBlue">DodgerBlue</option>
      <option style="background-color: Firebrick">Firebrick</option>
      <option style="background-color: FloralWhite">FloralWhite</option>
      <option style="background-color: ForestGreen">ForestGreen</option>
      <option style="background-color: Fuchsia">Fuchsia</option>
      <option style="background-color: Gainsboro">Gainsboro</option>
      <option style="background-color: GhostWhite">GhostWhite</option>
      <option style="background-color: Gold">Gold</option>
      <option style="background-color: Goldenrod">Goldenrod</option>
      <option style="background-color: Gray">Gray</option>
      <option style="background-color: Green">Green</option>
      <option style="background-color: GreenYellow">GreenYellow</option>
      <option style="background-color: Honeydew">Honeydew</option>
      <option style="background-color: HotPink">HotPink</option>
      <option style="background-color: IndianRed">IndianRed</option>
      <option style="background-color: Indigo">Indigo</option>
      <option style="background-color: Ivory">Ivory</option>
      <option style="background-color: Khaki">Khaki</option>
      <option style="background-color: Lavender">Lavender</option>
      <option style="background-color: LavenderBlush">LavenderBlush</option>
      <option style="background-color: LawnGreen">LawnGreen</option>
      <option style="background-color: LemonChiffon">LemonChiffon</option>
      <option style="background-color: LightBlue">LightBlue</option>
      <option style="background-color: LightCoral">LightCoral</option>
      <option style="background-color: LightCyan">LightCyan</option>
      <option style="background-color: LightGoldenrodYellow">LightGoldenrodYellow</option>
      <option style="background-color: LightGreen">LightGreen</option>
      <option style="background-color: LightGrey">LightGrey</option>
      <option style="background-color: LightPink">LightPink</option>
      <option style="background-color: LightSalmon">LightSalmon</option>
      <option style="background-color: LightSeaGreen">LightSeaGreen</option>
      <option style="background-color: LightSkyBlue">LightSkyBlue</option>
      <option style="background-color: LightSlateGray">LightSlateGray</option>
      <option style="background-color: LightSteelBlue">LightSteelBlue</option>
      <option style="background-color: LightYellow">LightYellow</option>
      <option style="background-color: Lime">Lime</option>
      <option style="background-color: LimeGreen">LimeGreen</option>
      <option style="background-color: Linen">Linen</option>
      <option style="background-color: Magenta">Magenta</option>
      <option style="background-color: Maroon">Maroon</option>
      <option style="background-color: MediumAquamarine">MediumAquamarine</option>
      <option style="background-color: MediumBlue">MediumBlue</option>
      <option style="background-color: MediumOrchid">MediumOrchid</option>
      <option style="background-color: MediumPurple">MediumPurple</option>
      <option style="background-color: MediumSeaGreen">MediumSeaGreen</option>
      <option style="background-color: MediumSlateBlue">MediumSlateBlue</option>
      <option style="background-color: MediumSpringGreen">MediumSpringGreen</option>
      <option style="background-color: MediumTurquoise">MediumTurquoise</option>
      <option style="background-color: MediumVioletRed">MediumVioletRed</option>
      <option style="background-color: MidnightBlue">MidnightBlue</option>
      <option style="background-color: MintCream">MintCream</option>
      <option style="background-color: MistyRose">MistyRose</option>
      <option style="background-color: Moccasin">Moccasin</option>
      <option style="background-color: NavajoWhite">NavajoWhite</option>
      <option style="background-color: Navy">Navy</option>
      <option style="background-color: OldLace">OldLace</option>
      <option style="background-color: Olive">Olive</option>
      <option style="background-color: OliveDrab">OliveDrab</option>
      <option style="background-color: Orange">Orange</option>
      <option style="background-color: OrangeRed">OrangeRed</option>
      <option style="background-color: Orchid">Orchid</option>
      <option style="background-color: PaleGoldenrod">PaleGoldenrod</option>
      <option style="background-color: PaleGreen">PaleGreen</option>
      <option style="background-color: PaleTurquoise">PaleTurquoise</option>
      <option style="background-color: PaleVioletRed">PaleVioletRed</option>
      <option style="background-color: PapayaWhip">PapayaWhip</option>
      <option style="background-color: PeachPuff">PeachPuff</option>
      <option style="background-color: Peru">Peru</option>
      <option style="background-color: Pink">Pink</option>
      <option style="background-color: Plum">Plum</option>
      <option style="background-color: PowderBlue">PowderBlue</option>
      <option style="background-color: Purple">Purple</option>
      <option style="background-color: Red">Red</option>
      <option style="background-color: RosyBrown">RosyBrown</option>
      <option style="background-color: RoyalBlue">RoyalBlue</option>
      <option style="background-color: SaddleBrown">SaddleBrown</option>
      <option style="background-color: Salmon">Salmon</option>
      <option style="background-color: SandyBrown">SandyBrown</option>
      <option style="background-color: SeaGreen">SeaGreen</option>
      <option style="background-color: Seashell">Seashell</option>
      <option style="background-color: Sienna">Sienna</option>
      <option style="background-color: Silver">Silver</option>
      <option style="background-color: SkyBlue">SkyBlue</option>
      <option style="background-color: SlateBlue">SlateBlue</option>
      <option style="background-color: SlateGray">SlateGray</option>
      <option style="background-color: Snow">Snow</option>
      <option style="background-color: SpringGreen">SpringGreen</option>
      <option style="background-color: SteelBlue">SteelBlue</option>
      <option style="background-color: Tan">Tan</option>
      <option style="background-color: Teal">Teal</option>
      <option style="background-color: Thistle">Thistle</option>
      <option style="background-color: Tomato">Tomato</option>
      <option style="background-color: Turquoise">Turquoise</option>
      <option style="background-color: Violet">Violet</option>
      <option style="background-color: Wheat">Wheat</option>
      <option style="background-color: White">White</option>
      <option style="background-color: WhiteSmoke">WhiteSmoke</option>
      <option style="background-color: Yellow">Yellow</option>
      <option style="background-color: YellowGreen">YellowGreen</option>
    </select>

    <canvas id="colorview" style="width: 30px; height: 30px; display: none">&nbsp;&nbsp;</canvas> <br/>

    半径(0 - 100): <input id="radius" type="number" value="20"> <br/>
    放射(0 - 100): <input id="nspoke" type="number" value="100"> <br/>
    乱数色相(0 - 360): <input id="randomhue" type="number" value="0"> <br/>
    FPS(15 - 60): <input id="fps" type="number" value="15"> <br/>
    フレーム数(2 - 10): <input id="framecount" type="number" value="2"> <br/>

    <button id="reset">りせっと</button>
    <button id="redraw">もっかい描画</button>
    <button id="openAsFile">画像として開く</button>
    <button id="save">保存する</button>
    <a id="downloadBtn" href="#" style="display: none;"></a>

    <hr />

    <p id="desc">ここ↓に画像ファイルをドラッグ＆ドロップしてね。</p>
    <canvas id="canvas" width="150" height="150" style="border: 2px solid blue">
    </canvas>
    <img id="animated-preview" style='display: none;'>

    <script type="text/javascript" src='lib/jsgif/LZWEncoder.js'></script>
    <script type="text/javascript" src='lib/jsgif/NeuQuant.js'></script>
    <script type="text/javascript" src='lib/jsgif/GIFEncoder.js'></script>
    <script type="text/javascript" src='lib/jsgif/b64.js'></script>
    <script type="text/javascript">
      /**************************************************************************/

      function gauss () {
        var sum = 0.0;

        for (var i = 0; i < 6; i++)
          sum += Math.random();

        return sum / 6.0;
      }

      function rangeRand (from, to) {
        var d = to - from;
        return Math.random(d) + from;
      }

      function rgb2hsv (r, g, b) {
        var v = Math.max(Math.max(r, g), b);
        var min = Math.min(Math.min(r, g), b);

        if (v == 0)
          return {h: 0, s: 0, v: 0};

        var d = v - min;
        var s = d / v;
        var rr = (v - r) / d;
        var gg = (v - g) / d;
        var bb = (v - b) / d;

        var h = v == r ? bb - gg :
                v == g ? 2 + rr - bb :
                         4 + gg - rr;

        if (h < 0)
          h += 1;

        return {h: h / 6, s: s, v: v};
      }

      var hsv2rgb = (function () {
        var hrtbl = [
          [0, 3, 1],
          [2, 0, 1],
          [1, 0, 3],
          [1, 2, 0],
          [3, 1, 0],
          [0, 1, 2]
        ];

        return function (h, s, v) {
          if (s == 0)
            return [v, v, v];

          h *= 6;
          var i = Math.floor(h);

          var f = h - i;
          var rs = [v, v * (1 - s), v * (1 - s * f), v * (1 - s * (1 - f))];
          var idx = hrtbl[i];

          return [rs[idx[0]], rs[idx[1]], rs[idx[2]]];
        };
      })();

      function clamp (v, from, to) {
        return v < from ? from :
               v > to   ? to :
               v;
      }

      function time (name, func, args, _this) {
        var a = new Date();
        var r = args ? func.apply(_this, args) : func();
        var b = new Date();
        return [(b.getTime() - a.getTime()) / 1000, r];
      }

      function logTime (name, func, args, _this) {
        var rt = time.apply(null, arguments);
        if (console && typeof console.log === 'function')
          console.log(name + ": " + rt[0] + "msec");
        return rt;
      }

      /**************************************************************************/

      function nova (context, opt) {
        var width = opt.width, height = opt.height;
        var xc = opt.xcenter, yc = opt.ycenter;
        var x1 = 0, y1 = 0, x2 = width, y2 = height;

        var imgData = context.getImageData(0, 0, width, height);
        var pixels = imgData.data;

        var spoke = [];
        var spokecolor = [];
        var hsv = rgb2hsv.apply(null, opt.color);

        for (var i = 0; i < opt.nspoke; i++) {
          spoke.push(gauss());
          hsv.h += opt.randomhue /
                    360.0 * rangeRand(-0.5, 0.5);

          if (hsv.h < 0)
            hsv.h += 1.0;
          else if (hsv.h >= 1.0)
            hsv.h -= 1.0;

          spokecolor.push(hsv2rgb(hsv.h, hsv.s, hsv.v));
        }

        for (var row = 0, y = 0; row < y2; row++, y++) {
          for (var col = 0, x = 0; col < x2; col++, x++) {
            var u = (x - xc) / opt.radius;
            var v = (y - yc) / opt.radius;
            var l = Math.sqrt(u * u + v * v);

            var t = (Math.atan2(u, v) / (2 * Math.PI) + 0.51) * opt.nspoke;
            var i = Math.floor(t);
            t -= i;
            i %= opt.nspoke;

            var w1 = spoke[i] * (1 - t) + spoke[(i + 1) % opt.nspoke] * t;
            w1 = w1 * w1;

            var w = 1 / (l + 0.001) * 0.9;
            var nova_alpha = clamp(w, 0.0, 1.0);
            var ratio = nova_alpha;
            var compl_ratio = 1.0 - ratio;
            var ptr = (y * width + x) * 4;

            for (var ci = 0; ci < 3; ci++ ) {
              var srccol = pixels[ptr + ci] / 255;
              var spokecol = spokecolor[i][ci] * (1.0 - t) + spokecolor[(i + 1) % opt.nspoke][ci] * t;

              var outcol = w > 1.0 ? clamp(spokecol * w, 0.0, 1.0) :
                                     srccol * compl_ratio + spokecol * ratio;

              var c = clamp(w1 * w, 0.0, 1.0);
              outcol += c;
              outcol *= 255;
              pixels[ptr + ci] = clamp(parseInt(outcol, 10), 0, 255);
            }
          }
        }

        context.putImageData(imgData, 0, 0);
      }

      function setCanvasWidthHeight () {
        canvas.width = img.width;
        canvas.height = img.height;
      }

      function drawBaseImage (context) {
        context.fillStyle = "rgb(255, 255, 255)";
        context.fillRect (0, 0, 150, 150);
        context.drawImage(img, 0, 0);
      }

      function clampedValue (id, from, to) {
        return clamp(parseInt(document.getElementById(id).value, 10), from, to);
      }

      function generateAniGIFDataURL (posList) {
        function createContext() {
          var c = document.createElement('canvas');
          c.width = canvas.width;
          c.height = canvas.height;
          return c.getContext('2d');
        }

        var context = createContext();
        var encoder = new GIFEncoder();
        encoder.setRepeat(0); // loop
        encoder.setDelay(1000 / clampedValue('fps', 15, 60));
        encoder.start();
        var frameCount = clampedValue('framecount', 2, 10);
        if (posList.length > 0) {
          for (var i = 0; i < frameCount; i++) {
            drawBaseImage(context);
            supernova(context, posList);
            encoder.addFrame(context);
          }
        }
        encoder.finish();
        var binaryGIF = encoder.stream().getData();
        return 'data:image/gif;base64,'+encode64(binaryGIF);
      }

      function supernova (context, posList) {
        posList.forEach(function (pos) {
          nova(context, {
            width: img.width,
            height: img.height,
            xcenter: pos.x,
            ycenter: pos.y,
            color: rgbdata || [0.35, 0.39, 1.0, 1.0],
            radius: clampedValue('radius', 0, 100),
            nspoke: clampedValue('nspoke', 1, 100),
            randomhue: clampedValue('randomhue', 0, 360),
          });
        });
      }

      function animateSupernova (posList) {
        var dataURL = generateAniGIFDataURL(posList);
        var preview = document.getElementById('animated-preview');
        preview.style.display = 'inline';
        preview.src = dataURL;
      }


      var rgbdata;
      var clickedPosList = [];
      var color = document.getElementById("color");
      var colorvalue = document.getElementById("colorvalue");
      var colorview = document.getElementById("colorview");
      var reset = document.getElementById("reset");
      var redraw = document.getElementById("redraw");
      var desc = document.getElementById("desc");
      var dropbox = document.getElementById("canvas");
      var canvas = document.getElementById('canvas');
      var img = document.getElementById('pic');
      var context = canvas.getContext('2d');
      var openAsFile = document.getElementById('openAsFile');
      var save = document.getElementById('save');

      // ブラウザ判定: https://qiita.com/sakuraya/items/33f93e19438d0694a91d
      var userAgent = window.navigator.userAgent.toLowerCase();
      var platform = {
        isChrome: userAgent.indexOf('chrome') != -1,
        isFirefox: userAgent.indexOf('firefox') != -1,
      };

      img.addEventListener(
        'load',
        function () {
          desc.textContent = "光らせたい場所をクリックしてね！";
          setCanvasWidthHeight();
          drawBaseImage(context);
        },
        false
      );

      reset.addEventListener(
        'click',
        function () {
          var preview = document.getElementById('animated-preview');
          preview.style.display = 'none';

          clickedPosList = [];

          setCanvasWidthHeight();
          drawBaseImage(context);
        },
        true
      );

      redraw.addEventListener(
        'click',
        function () {
          setCanvasWidthHeight();
          drawBaseImage(context);
          // 静止画 canvas を更新
          supernova(context, clickedPosList);
          // アニメ GIF の img 要素を更新
          if (clickedPosList.length > 0) {
            animateSupernova(clickedPosList);
          }
        },
        true
      );

      dropbox.addEventListener(
        'dragenter',
        function (e) {
          e.stopPropagation();
          e.preventDefault();
        },
        false
      );

      dropbox.addEventListener(
        'dragover',
        function (e) {
          e.stopPropagation();
          e.preventDefault();
        },
        false
      );

      dropbox.addEventListener(
        'drop',
        function (e) {
          e.stopPropagation();
          e.preventDefault();

          var file = e.dataTransfer.files[0];
          var reader = new FileReader();
          reader.onloadend = function () {
            img.src = reader.result;
            reset.click();
          };
          reader.readAsDataURL(file);
        },
        false
      );

      canvas.addEventListener(
        'click',
        function (e) {
          desc.textContent = "光らせた画像は、右クリックメニューから保存できるよ！";
          clickedPosList.push({
            x: e.pageX - e.target.offsetLeft - 2,
            y: e.pageY - e.target.offsetTop - 2,
          });
          setCanvasWidthHeight();
          drawBaseImage(context);
          // 静止画 canvas を更新
          supernova(context, clickedPosList);
          // アニメ GIF の img 要素を更新
          animateSupernova(clickedPosList);
        },
        true
      );


      (function () {
        function colorOnChange () {
          var context = colorview.getContext('2d');
          context.fillStyle = color.value;
          context.fillRect(0, 0, 100, 100);
          var cs = context.getImageData(0, 0, 1, 1).data;
          rgbdata = [cs[0] / 255, cs[1] / 255, cs[2] / 255];
          colorvalue.textContent = cs.slice(0, 3);
        }

        color.addEventListener(
          'change',
          colorOnChange,
          true
        );

        colorOnChange();
      })();

      openAsFile.addEventListener(
        'click', 
        (function () {
          var prevObjectURL;

          return function () {
            if (platform.isFirefox) {
              var url = canvas.toDataURL();
              window.open(url);
            } else if (platform.isChrome) {
              canvas.toBlob(function (blob) {
                if (prevObjectURL) {
                  URL.revokeObjectURL(prevObjectURL);
                }
                prevObjectURL = URL.createObjectURL(blob);
                window.open(prevObjectURL);
              });
            } else {
              alert('Chrome か Firefox でうごきます');
            }
          };
        })(),
        true
      );

      save.addEventListener(
        'click', 
        function () {
          var url = canvas.toDataURL().replace('image/png', 'application/octet');
          var downloadBtn = document.getElementById('downloadBtn');
          downloadBtn.href = url;
          downloadBtn.download = 'bikabika.gif';
          downloadBtn.click();
        },
        true
      );

    </script>

  </body>
</html>
